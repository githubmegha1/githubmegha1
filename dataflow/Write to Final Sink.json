{
	"name": "Write to Final Sink",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "Parquet1",
						"type": "DatasetReference"
					},
					"name": "CTIncrementalStagingTable"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "AzureSynapseAnalyticsTable1",
						"type": "DatasetReference"
					},
					"name": "FinalSinkTable"
				}
			],
			"transformations": [
				{
					"name": "ScriptSetKeyColumnValueToCTKeyValue"
				},
				{
					"name": "SetAlterRowConditions"
				},
				{
					"name": "derivedColumn1"
				},
				{
					"name": "derivedColumn2"
				}
			],
			"scriptLines": [
				"parameters{",
				"     p_SinkKeyColumn as string (\"CompanyID\"),",
				"     p_CTKeyColumnName as string (\"CTKey\"),",
				"     p_SYS_CHANGE_OPERATION as string (\"I\"),",
				"     p_SinkTableName as string (\"Company\"),",
				"     p_Folder as string (\"Erecruit_Parallon/Company/2023/04/14/\"),",
				"     p_Filename as string (\"Company_Incremental_2023-04-14T16:12:41.3430923Z.parquet\"),",
				"     p_ArchiveFolder as string (\"Company/Archive\")",
				"}",
				"source(output(",
				"          SourceSystemCode as string,",
				"          LoadDate as timestamp,",
				"          UpdateDate as timestamp,",
				"          COMPANY_ID as integer,",
				"          NAME as string,",
				"          ADDRESS_LINE1 as string,",
				"          CITY as string,",
				"          POSTAL_CODE as string,",
				"          PHONE as string,",
				"          FAX as string,",
				"          EMAIL as string,",
				"          HOME_PAGE as string,",
				"          DEFAULT_CONTRACT_ID as integer,",
				"          CONTRACT_REMINDER_LEVEL as integer,",
				"          LIST as boolean,",
				"          CONTRACT_EXPIRES as timestamp,",
				"          CONTRACT_SW as boolean,",
				"          DESCRIPTION as string,",
				"          DIRECTIONS as string,",
				"          DAYS_TO_PAY as decimal(6,0),",
				"          FEE_PERCENTAGE as float,",
				"          CONTRACTOR_FEE_PERCENTAGE as float,",
				"          FLAT_FEE as decimal(19,4),",
				"          AD_SOURCE as string,",
				"          HR_REP_ID as integer,",
				"          CONTRACT_NOTES as string,",
				"          MANAGERS_NOTES as string,",
				"          HR_NOTES as string,",
				"          REGION_ID as integer,",
				"          STATE as string,",
				"          COUNTRY as string,",
				"          DATE_ENTERED as timestamp,",
				"          CONTRACT_SENT as timestamp,",
				"          INDUSTRY_SUB_ID as integer,",
				"          INDUSTRY as string,",
				"          COMPANY_SUBM as integer,",
				"          COMPANY_INV as integer,",
				"          COMPANY_F_INT as integer,",
				"          COMPANY_OFFER as integer,",
				"          COMPANY_PLAC as integer,",
				"          COMPANY_BILLING as decimal(19,4),",
				"          COMPANY_AVG_D as float,",
				"          COMPANY_RATING as float,",
				"          DUPGROUP as string,",
				"          DUPFLAG as string,",
				"          DUPFREQ as string,",
				"          DONOTCALL as boolean,",
				"          VMS_SW as boolean,",
				"          BH_ID as integer,",
				"          OwnerID as string,",
				"          IsOwnershipPermanent as boolean,",
				"          IsAgreementRequired as boolean,",
				"          IsSummaryBilling as boolean,",
				"          StatusID as integer,",
				"          DefaultBillTo as integer,",
				"          LastNoteID as long,",
				"          InvoiceBatchID as integer,",
				"          PaymentTermsID as integer,",
				"          TimesheetPeriodsRangeCalendarID as integer,",
				"          Timestamp as binary,",
				"          FYEndDate as integer,",
				"          IsMergedTo as integer,",
				"          CompanyStatusChangedToActiveDate as date,",
				"          OwnerEntityID as string,",
				"          AdsourceAdditionalInfo as string,",
				"          PrimaryPhone as string,",
				"          PrimaryPhoneTypeName as string,",
				"          PrimaryEmail as string,",
				"          PrimaryEmailTypeName as string,",
				"          AutoCreateTimesheets as boolean,",
				"          CompanyTypeID as integer,",
				"          InvoiceTemplateID as integer,",
				"          OpportunityID as long,",
				"          VMSBurdenID as integer,",
				"          ExpenseTypeID as integer,",
				"          SplitTimesheetsForMonthlyBilling as boolean,",
				"          TimesheetCreationOption as integer,",
				"          InvoiceTemplateIDPerm as integer,",
				"          TimesheetEntryTemplateID as integer,",
				"          DefaultContactID as integer,",
				"          EmailCC as string,",
				"          NeedsIndexing as boolean,",
				"          AllowEmptyTimesheets as boolean,",
				"          ExternalVendorID as string,",
				"          LoadVouchersAsOnHold as boolean,",
				"          ARCollectorUserID as string,",
				"          CashOnAccount as decimal(19,4),",
				"          TimesheetRangeCalendarID as integer,",
				"          TimesheetBatchID as integer,",
				"          TimesheetNotificationOptions as integer,",
				"          DefaultAddressID as long,",
				"          CreditScore as string,",
				"          LegalName as string,",
				"          CreditLimit as double,",
				"          LateFeePercentage as double,",
				"          ShowTimesheetBillingTotalToContact as boolean,",
				"          InvoiceModeID as integer,",
				"          OvertimeTypeID as integer,",
				"          DefaultFolderGroupID as integer,",
				"          CancellationDays as integer,",
				"          AdminBurdenID as integer,",
				"          OvertimeMultiplier as decimal(9,4),",
				"          DoubletimeMultiplier as decimal(9,4),",
				"          DivisionMarketID as integer,",
				"          DefaultBillRateMarkupPercentage as decimal(18,6),",
				"          DefaultVendorRateMarkupPercentage as decimal(18,6),",
				"          DefaultRateHolidayListID as integer,",
				"          ContactPortalInfo as string,",
				"          InvoiceDiscountPercent as decimal(22,10),",
				"          CONTACT_ID_APPROVETIMESHEET as integer,",
				"          InvoiceTemplateIDMilestone as integer,",
				"          MilestoneTransactionTypeID as integer,",
				"          DefaultClientProjectID as integer,",
				"          VATID as string,",
				"          CreatedBy as string,",
				"          RoutingFlagID as integer,",
				"          TLBillProcessingCalendarID as integer,",
				"          LastModifiedOn as timestamp,",
				"          PONumberRequiredOnTimesheetEntry as boolean,",
				"          PONumberVisibleOnTimesheetEntry as boolean,",
				"          DefaultCompanyPONumberID as integer,",
				"          SalesTaxExemptStates as string,",
				"          TimesheetBillRateMarginPercent as decimal(5,4),",
				"          AdSourceId as integer,",
				"          CTKey as integer,",
				"          SYS_CHANGE_VERSION as long,",
				"          SYS_CHANGE_OPERATION as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: true,",
				"     moveFiles: [(concat($p_Folder,$p_Filename)),(concat($p_ArchiveFolder,'/',$p_Filename))],",
				"     format: 'parquet',",
				"     wildcardPaths:[(concat(toString($p_Folder), toString($p_Filename)))],",
				"     fileSystem: 'htwssyndevs1a') ~> CTIncrementalStagingTable",
				"derivedColumn1 derive(each(match(name==iif(name==$p_SinkKeyColumn,name,'noMatch')), $$ = byName($p_CTKeyColumnName))) ~> ScriptSetKeyColumnValueToCTKeyValue",
				"ScriptSetKeyColumnValueToCTKeyValue alterRow(deleteIf(toString(byName($p_SYS_CHANGE_OPERATION))==('D')),",
				"     upsertIf(toString(byName($p_SYS_CHANGE_OPERATION))==('U')||toString(byName($p_SYS_CHANGE_OPERATION))==('I'))) ~> SetAlterRowConditions",
				"derivedColumn2 derive(SourceSystemCode = \"WF\") ~> derivedColumn1",
				"CTIncrementalStagingTable derive(each(match(type=='String'&&length(name)>4000), $$ = substring($$, 1, 4000))) ~> derivedColumn2",
				"SetAlterRowConditions sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          COMPANY_ID as integer,",
				"          NAME as string,",
				"          ADDRESS_LINE1 as string,",
				"          CITY as string,",
				"          POSTAL_CODE as string,",
				"          PHONE as string,",
				"          FAX as string,",
				"          EMAIL as string,",
				"          HOME_PAGE as string,",
				"          DEFAULT_CONTRACT_ID as integer,",
				"          CONTRACT_REMINDER_LEVEL as integer,",
				"          LIST as boolean,",
				"          CONTRACT_EXPIRES as timestamp,",
				"          CONTRACT_SW as boolean,",
				"          DESCRIPTION as string,",
				"          DIRECTIONS as string,",
				"          DAYS_TO_PAY as decimal(6,0),",
				"          FEE_PERCENTAGE as float,",
				"          CONTRACTOR_FEE_PERCENTAGE as float,",
				"          FLAT_FEE as decimal(19,4),",
				"          AD_SOURCE as string,",
				"          HR_REP_ID as integer,",
				"          CONTRACT_NOTES as string,",
				"          MANAGERS_NOTES as string,",
				"          HR_NOTES as string,",
				"          REGION_ID as integer,",
				"          STATE as string,",
				"          COUNTRY as string,",
				"          DATE_ENTERED as timestamp,",
				"          CONTRACT_SENT as timestamp,",
				"          INDUSTRY_SUB_ID as integer,",
				"          INDUSTRY as string,",
				"          COMPANY_SUBM as integer,",
				"          COMPANY_INV as integer,",
				"          COMPANY_F_INT as integer,",
				"          COMPANY_OFFER as integer,",
				"          COMPANY_PLAC as integer,",
				"          COMPANY_BILLING as decimal(19,4),",
				"          COMPANY_AVG_D as float,",
				"          COMPANY_RATING as float,",
				"          DUPGROUP as string,",
				"          DUPFLAG as string,",
				"          DUPFREQ as string,",
				"          DONOTCALL as boolean,",
				"          VMS_SW as boolean,",
				"          BH_ID as integer,",
				"          OwnerID as string,",
				"          IsOwnershipPermanent as boolean,",
				"          IsAgreementRequired as boolean,",
				"          IsSummaryBilling as boolean,",
				"          StatusID as integer,",
				"          DefaultBillTo as integer,",
				"          LastNoteID as long,",
				"          InvoiceBatchID as integer,",
				"          PaymentTermsID as integer,",
				"          TimesheetPeriodsRangeCalendarID as integer,",
				"          Timestamp as string,",
				"          FYEndDate as integer,",
				"          IsMergedTo as integer,",
				"          CompanyStatusChangedToActiveDate as date,",
				"          OwnerEntityID as string,",
				"          AdsourceAdditionalInfo as string,",
				"          PrimaryPhone as string,",
				"          PrimaryPhoneTypeName as string,",
				"          PrimaryEmail as string,",
				"          PrimaryEmailTypeName as string,",
				"          AutoCreateTimesheets as boolean,",
				"          CompanyTypeID as integer,",
				"          InvoiceTemplateID as integer,",
				"          OpportunityID as long,",
				"          VMSBurdenID as integer,",
				"          ExpenseTypeID as integer,",
				"          SplitTimesheetsForMonthlyBilling as boolean,",
				"          TimesheetCreationOption as integer,",
				"          InvoiceTemplateIDPerm as integer,",
				"          TimesheetEntryTemplateID as integer,",
				"          DefaultContactID as integer,",
				"          EmailCC as string,",
				"          NeedsIndexing as boolean,",
				"          AllowEmptyTimesheets as boolean,",
				"          ExternalVendorID as string,",
				"          LoadVouchersAsOnHold as boolean,",
				"          ARCollectorUserID as string,",
				"          CashOnAccount as decimal(19,4),",
				"          TimesheetRangeCalendarID as integer,",
				"          TimesheetBatchID as integer,",
				"          TimesheetNotificationOptions as integer,",
				"          DefaultAddressID as long,",
				"          CreditScore as string,",
				"          LegalName as string,",
				"          CreditLimit as double,",
				"          LateFeePercentage as double,",
				"          ShowTimesheetBillingTotalToContact as boolean,",
				"          InvoiceModeID as integer,",
				"          OvertimeTypeID as integer,",
				"          DefaultFolderGroupID as integer,",
				"          CancellationDays as integer,",
				"          AdminBurdenID as integer,",
				"          OvertimeMultiplier as decimal(9,4),",
				"          DoubletimeMultiplier as decimal(9,4),",
				"          DivisionMarketID as integer,",
				"          DefaultBillRateMarkupPercentage as decimal(18,6),",
				"          DefaultVendorRateMarkupPercentage as decimal(18,6),",
				"          DefaultRateHolidayListID as integer,",
				"          ContactPortalInfo as string,",
				"          InvoiceDiscountPercent as decimal(22,10),",
				"          CONTACT_ID_APPROVETIMESHEET as integer,",
				"          InvoiceTemplateIDMilestone as integer,",
				"          MilestoneTransactionTypeID as integer,",
				"          DefaultClientProjectID as integer,",
				"          VATID as string,",
				"          CreatedBy as string,",
				"          RoutingFlagID as integer,",
				"          TLBillProcessingCalendarID as integer,",
				"          LastModifiedOn as timestamp,",
				"          PONumberRequiredOnTimesheetEntry as boolean,",
				"          PONumberVisibleOnTimesheetEntry as boolean,",
				"          DefaultCompanyPONumberID as integer,",
				"          SalesTaxExemptStates as string,",
				"          TimesheetBillRateMarginPercent as decimal(5,4),",
				"          AdSourceId as integer,",
				"          SourceSystemCode as string,",
				"          LoadDate as timestamp,",
				"          UpdateDate as timestamp",
				"     ),",
				"     deletable:true,",
				"     insertable:false,",
				"     updateable:false,",
				"     upsertable:true,",
				"     keys:['SourceSystemCode',($p_SinkKeyColumn)],",
				"     format: 'table',",
				"     staged: true,",
				"     allowCopyCommand: true,",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     saveOrder: 1,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     store: 'synapseanalytics',",
				"     schemaName: 'dbo') ~> FinalSinkTable"
			]
		}
	}
}